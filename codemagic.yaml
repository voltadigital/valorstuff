workflows:
  Build App For IOS and ANDROID:
    instance_type: mac_mini
    scripts:
      - name: Download Required Packages
        script: |
                  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
                  echo "----------------------------------------------------------------------------------"
                  sudo ln -sfn /usr/local/opt/openssl /usr/local/ssl
                  echo "----------------------------------------------------------------------------------"
                  brew install pkg-config sdl2 sdl2_image sdl2_ttf sdl2_mixer gstreamer autoconf automake
                  echo "----------------------------------------------------------------------------------"
                  python3 -m pip install --upgrade pip
                  echo "----------------------------------------------------------------------------------"
                  pip3 install --user --upgrade buildozer cython kivy aiohttp kivymd asynckivy virtualenv kivy-ios
                  echo "----------------------------------------------------------------------------------"
        
      - name: Create Folders
        script: |
                  echo "MKDIR"
                  mkdir /Users/builder/.buildozer
                  mkdir /Users/builder/.buildozer/android 
                  mkdir /Users/builder/.buildozer/android/platform 
                  mkdir /Users/builder/.buildozer/android/platform/android-sdk
                  mkdir /Users/builder/.buildozer/android/platform/android-sdk/tools
                  mkdir /Users/builder/.buildozer/android/platform/android-sdk/tools/bin
                  
      
      - name: Remove Unused Files
        script: |
                  rm -r $HOME/programs/flutter
                  rm /Applications/Xcode-13.3.app
                  rm /Applications/Xcode-14.0.app
                  rm -r /Users/builder/.android/avd/emulator.avd

      - name: Load Android SDK
        script: |
                  echo "----------------------------------------------------------------------------------"
                  yes | /usr/local/share/android-sdk/cmdline-tools/latest/bin/sdkmanager --sdk_root=/Users/builder/.buildozer/android/platform/android-sdk --licenses && /usr/local/share/android-sdk/cmdline-tools/latest/bin/sdkmanager --sdk_root=/Users/builder/.buildozer/android/platform/android-sdk platform-tools && /usr/local/share/android-sdk/cmdline-tools/latest/bin/sdkmanager --sdk_root=/Users/builder/.buildozer/android/platform/android-sdk --install "cmake;3.18.1" && /usr/local/share/android-sdk/cmdline-tools/latest/bin/sdkmanager --sdk_root=/Users/builder/.buildozer/android/platform/android-sdk "build-tools;30.0.2" && /usr/local/share/android-sdk/cmdline-tools/latest/bin/sdkmanager --update || { echo 'ANDROID SDK UPDATES FAILED' ; exit 1; } 
                  echo "----------------------------------------------------------------------------------"
                  sudo rsync -vua /usr/local/share/android-sdk/tools/bin/sdkmanager /Users/builder/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager 

      - name: Run Buildozer
        script: |
                  buildozer android release || { echo 'ANDROID FAILIURE' ; exit 1; }
                  echo "----------------------------------------------------------------------------------"
                  buildozer ios release || { echo 'IOS FAILIURE' ; exit 1; }

    artifacts:
      - ./bin/*.aab
      - ./bin/*.apk
      - ./bin/*.aar
      - ./bin/*.app
      - ./bin/*.ipa
      - ./bin/*.pkg
      - ./bin/*.jar
      - ./bin/*.zip
      - ./bin/*.xarchive